{% extends 'base.html' %}
{% load static %}

{% block title %}Set New Password - SudaStock{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="container auth-page">
    <div class="row justify-content-center w-100">
        <div class="col-md-6 col-lg-5">
            <div class="auth-form-container">
                <div class="auth-form-content">
                    <div class="auth-header">
                        <div class="auth-logo">
                            <span style="color: var(--primary-dark);">Suda</span><span style="color: var(--accent);">Stock</span>
                        </div>
                        <p class="auth-subtitle">Create New Password</p>
                    </div>
                    
                    {% if validlink %}
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Please create a new secure password for your account.
                        </div>
                        
                        <form method="post" class="needs-validation" novalidate id="resetPasswordForm">
                            {% csrf_token %}
                            
                            <div class="form-floating mb-4">
                                <input type="password" class="form-control" id="id_new_password1" name="new_password1" placeholder="New Password" required minlength="8">
                                <label for="id_new_password1"><i class="fas fa-lock me-2"></i>New Password</label>
                                <div class="invalid-feedback">
                                    Password must be at least 8 characters long.
                                </div>
                            </div>
                            
                            <div class="form-floating mb-4">
                                <input type="password" class="form-control" id="id_new_password2" name="new_password2" placeholder="Confirm Password" required>
                                <label for="id_new_password2"><i class="fas fa-lock me-2"></i>Confirm Password</label>
                                <div class="invalid-feedback">
                                    Passwords do not match.
                                </div>
                            </div>
                            
                            <div class="password-strength mb-4">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="password-feedback mt-2 text-muted">
                                    <small>Password strength: <span id="strength-text">Too weak</span></small>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary auth-btn">
                                    <i class="fas fa-save me-2"></i>Set New Password
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-danger mb-4">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            The password reset link is invalid or has expired. Please request a new password reset link.
                        </div>
                        
                        <div class="text-center mb-4">
                            <img src="{% static 'images/error.svg' %}" alt="Error" class="img-fluid" style="max-width: 200px;">
                        </div>
                        
                        <div class="d-grid gap-2">
                            <a href="{% url 'password_reset' %}" class="btn btn-primary auth-btn">
                                <i class="fas fa-redo me-2"></i>Request New Reset Link
                            </a>
                        </div>
                    {% endif %}
                    
                    <div class="auth-footer">
                        <p>Remember your password? <a href="{% url 'login' %}">Back to Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    (function() {
        'use strict';
        
        // Fetch all forms we want to apply validation to
        var forms = document.querySelectorAll('.needs-validation');
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                // Check if passwords match
                var password1 = document.getElementById('id_new_password1');
                var password2 = document.getElementById('id_new_password2');
                
                if (password1 && password2 && password1.value !== password2.value) {
                    password2.setCustomValidity('Passwords do not match');
                    event.preventDefault();
                    event.stopPropagation();
                } else if (password2) {
                    password2.setCustomValidity('');
                }
                
                form.classList.add('was-validated');
            }, false);
        });
        
        // Password strength meter
        var passwordInput = document.getElementById('id_new_password1');
        var progressBar = document.querySelector('.password-strength .progress-bar');
        var strengthText = document.getElementById('strength-text');
        
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                var password = this.value;
                var strength = 0;
                
                // Length check
                if (password.length >= 8) {
                    strength += 25;
                }
                
                // Contains lowercase
                if (/[a-z]/.test(password)) {
                    strength += 25;
                }
                
                // Contains uppercase
                if (/[A-Z]/.test(password)) {
                    strength += 25;
                }
                
                // Contains number or special char
                if (/[0-9!@#$%^&*(),.?":{}|<>]/.test(password)) {
                    strength += 25;
                }
                
                // Update progress bar
                progressBar.style.width = strength + '%';
                progressBar.setAttribute('aria-valuenow', strength);
                
                // Update color based on strength
                if (strength <= 25) {
                    progressBar.className = 'progress-bar bg-danger';
                    strengthText.textContent = 'Too weak';
                } else if (strength <= 50) {
                    progressBar.className = 'progress-bar bg-warning';
                    strengthText.textContent = 'Weak';
                } else if (strength <= 75) {
                    progressBar.className = 'progress-bar bg-info';
                    strengthText.textContent = 'Medium';
                } else {
                    progressBar.className = 'progress-bar bg-success';
                    strengthText.textContent = 'Strong';
                }
            });
        }
    })();
</script>
{% endblock %}
