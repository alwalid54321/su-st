{% extends 'admin/base_admin.html' %}

{% block title %}SudaStock - Announcements Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-lg announcement-card">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center bg-primary-dark text-white">
                    <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Announcements Management</h6>
                    <button type="button" class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#announcementModal">
                        <i class="fas fa-plus me-2"></i>Add New Announcement
                    </button>
                </div>
                <div class="card-body px-0 pt-3 pb-2">
                    <div class="table-responsive p-0">
                        <table class="table align-items-center mb-0 table-hover">
                            <thead class="thead-accent">
                                <tr>
                                    <th class="text-uppercase font-weight-bolder ps-3">Title</th>
                                    <th class="text-uppercase font-weight-bolder ps-2">Content</th>
                                    <th class="text-uppercase font-weight-bolder ps-2">Priority</th>
                                    <th class="text-uppercase font-weight-bolder ps-2">Created</th>
                                    <th class="text-uppercase font-weight-bolder ps-2">Status</th>
                                    <th class="opacity-7 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTableBody">
                                {% for announcement in announcements %}
                                <tr class="announcement-row">
                                    <td>
                                        <div class="d-flex px-3 py-2">
                                            <div class="d-flex flex-column justify-content-center">
                                                <h6 class="mb-0 announcement-title">{{ announcement.title }}</h6>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <p class="font-weight-bold mb-0 announcement-content">{{ announcement.content|truncatechars:50 }}</p>
                                    </td>
                                    <td>
                                        <span class="badge bg-gradient-{% if announcement.priority == 'high' %}danger{% elif announcement.priority == 'medium' %}warning{% else %}info{% endif %} announcement-priority">
                                            {{ announcement.priority|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="font-weight-bold announcement-date"><i class="far fa-calendar-alt me-2" style="color: var(--accent);"></i>{{ announcement.created_at|date:"M d, Y H:i" }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-gradient-{% if announcement.status == 'active' %}success{% else %}secondary{% endif %} announcement-status">
                                            {{ announcement.status|title }}
                                        </span>
                                    </td>
                                    <td class="align-middle text-center">
                                        <button class="btn btn-link text-primary mb-0 edit-announcement" 
                                                data-id="{{ announcement.id }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#announcementModal">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-link text-danger mb-0 delete-announcement" 
                                                data-id="{{ announcement.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="empty-state">
                                            <i class="fas fa-bullhorn fa-3x mb-3" style="color: var(--accent);"></i>
                                            <p>No announcements available</p>
                                            <button type="button" class="btn btn-accent btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#announcementModal">
                                                <i class="fas fa-plus me-2"></i>Create First Announcement
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Announcement Modal -->
<div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-primary-dark text-white border-bottom border-accent">
                <h5 class="modal-title" id="announcementModalLabel"><i class="fas fa-bullhorn me-2"></i>Add/Edit Announcement</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="announcementForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="announcementId" name="id" value="">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="title" class="form-label text-light">Title</label>
                                <input type="text" class="form-control bg-dark text-light border-accent" id="title" name="title" required>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="content" class="form-label text-light">Content</label>
                                <textarea class="form-control bg-dark text-light border-accent" id="content" name="content" rows="5" required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="priority" class="form-label text-light">Priority</label>
                                <select class="form-control bg-dark text-light border-accent" id="priority" name="priority">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status" class="form-label text-light">Status</label>
                                <select class="form-control bg-dark text-light border-accent" id="status" name="status">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top border-accent">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-accent">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add animation to cards
        const cards = document.querySelectorAll('.announcement-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('fade-in');
            }, index * 100);
        });
        
        // Add hover effect to table rows
        const tableRows = document.querySelectorAll('.announcement-row');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', () => {
                row.style.boxShadow = '0 0 15px rgba(120, 109, 60, 0.3)';
                row.style.transform = 'translateX(5px)';
            });
            row.addEventListener('mouseleave', () => {
                row.style.boxShadow = 'none';
                row.style.transform = 'translateX(0)';
            });
        });
        
        // Edit Announcement
        const editButtons = document.querySelectorAll('.edit-announcement');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                fetch(`/api/announcements/${id}/`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('announcementId').value = data.id;
                        document.getElementById('title').value = data.title;
                        document.getElementById('content').value = data.content;
                        document.getElementById('priority').value = data.priority;
                        document.getElementById('status').value = data.status;
                    })
                    .catch(error => console.error('Error fetching announcement:', error));
            });
        });

        // Delete Announcement
        const deleteButtons = document.querySelectorAll('.delete-announcement');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this announcement?')) {
                    const id = this.getAttribute('data-id');
                    fetch(`/api/announcements/${id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            window.location.reload();
                        } else {
                            throw new Error('Failed to delete announcement');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting announcement:', error);
                        alert('Failed to delete announcement. Please try again.');
                    });
                }
            });
        });

        // Form Submission
        document.getElementById('announcementForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const id = formData.get('id');
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/announcements/${id}/` : '/api/announcements/';
            
            fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: formData.get('title'),
                    content: formData.get('content'),
                    priority: formData.get('priority'),
                    status: formData.get('status')
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Failed to save announcement');
                }
            })
            .catch(error => {
                console.error('Error saving announcement:', error);
                alert('Failed to save announcement. Please try again.');
            });
        });
    });
</script>

<style>
    .announcement-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(120, 109, 60, 0.2);
        overflow: hidden;
    }
    
    .announcement-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 0 0 15px rgba(120, 109, 60, 0.2);
    }
    
    .card-header {
        position: relative;
        overflow: hidden;
    }
    
    .card-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }
    
    .thead-accent {
        background: linear-gradient(135deg, rgba(27, 20, 100, 0.9), rgba(27, 20, 100, 0.7));
        color: var(--light-text);
        border-bottom: 2px solid var(--accent);
    }
    
    .thead-accent th {
        font-weight: 600;
        padding: 1rem;
        text-shadow: 0 0 5px rgba(120, 109, 60, 0.5);
    }
    
    .announcement-title {
        color: var(--light-text);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .announcement-content {
        color: var(--light-text);
        opacity: 0.8;
        font-size: 0.875rem;
    }
    
    .announcement-date {
        color: var(--light-text);
        font-size: 0.875rem;
    }
    
    .announcement-priority, .announcement-status {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
        text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }
    
    .empty-state {
        padding: 2rem;
        text-align: center;
    }
    
    .bg-primary-dark {
        background: linear-gradient(135deg, var(--primary-dark), rgba(27, 20, 100, 0.8));
    }
    
    .bg-accent {
        background: linear-gradient(135deg, var(--accent), rgba(120, 109, 60, 0.8));
    }
    
    .border-accent {
        border-color: var(--accent) !important;
    }
    
    .btn-accent {
        background: linear-gradient(135deg, var(--accent), rgba(120, 109, 60, 0.8));
        color: white;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-accent:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(120, 109, 60, 0.3);
        color: white;
    }
    
    .table-hover tbody tr {
        transition: all 0.3s ease;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(120, 109, 60, 0.1);
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}
