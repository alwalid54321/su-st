{% extends 'base.html' %}
{% load static %}

{% block title %}Products - SudaStock{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
<link rel="stylesheet" href="{% static 'css/vertical-products.css' %}">
{% endblock %}

{% block content %}
<div class="products-page">
  <div class="products-hero">
    <div class="hero-content">
      <h1>Our Premium Products</h1>
      <p>Discover Sudan's finest agricultural treasures</p>
    </div>
  </div>

  <div class="why-products-section">
    <h2>WHY OUR PRODUCTS</h2>
    <div class="why-products-content">
      <div class="why-products-left">
        <div class="why-product-item">
          <h3>Direct from Sudan</h3>
          <p>Our products are meticulously sourced from Sudan, where they are cultivated, harvested, processed, and shipped from their origin.</p>
        </div>
        <div class="why-product-item">
          <h3>Transparent Pricing</h3>
          <p>We provide prices that reflect the current market rates without any hidden profit margin. Samples can be requested.</p>
        </div>
      </div>

      <div class="why-products-center">
        <img src="{% static 'images/products-center.jpg' %}" alt="Featured Product" class="center-image" />
      </div>

      <div class="why-products-right">
        <div class="why-product-item">
          <h3>Quality Standards</h3>
          <p>Our products are sourced from Sudan, known for its exceptional agricultural conditions and high standards.</p>
        </div>
        <div class="why-product-item">
          <h3>Customer Focus</h3>
          <p>We provide information on seasonal availability and trends in pricing, to ease your plan for purchasing taking advantage of lower prices or higher-quality products.</p>
        </div>
      </div>
    </div>

    <div class="products-cta">
      <div class="cta-box">
        <h3>Reach Out</h3>
        <p>Get a personalized quotation on our featured products</p>
        <a href="{% url 'quote' %}" class="cta-button">Get Quote</a>
      </div>
      <div class="cta-box">
        <h3>Discover</h3>
        <p>Request a trial today of any of our products and experience the quality for yourself</p>
        <a href="{% url 'sample' %}" class="cta-button">Request Sample</a>
      </div>
    </div>
  </div>
  
  <div class="filter-section">
    <div class="filter-buttons">
      <button class="category-btn active" data-category="all">All Products</button>
      <button class="category-btn" data-category="sesame">Oilseeds</button>
      <button class="category-btn" data-category="cotton">Fibers</button>
      <button class="category-btn" data-category="gum">Gums</button>
      <button class="category-btn" data-category="others">Other</button>
    </div>
  </div>

  <!-- Vertical Products Section -->
  <section class="vertical-products-section">
    <div class="container">
      <div class="vertical-products-container">
        {% for product in products %}
        <div id="{{ product.id }}" class="vertical-product-card" data-product="{{ product.id }}" data-category="{{ product.category }}">
          <img src="{% static product.image %}" alt="{{ product.name }}" class="vertical-product-image">
          <div class="product-info-box">
            <div class="product-price">
              <span class="price-label">Price:</span>
              <span class="price-value">${{ product.price|default:"Call for price" }}</span>
            </div>
            <div class="product-state">
              <span class="state-label">Status:</span>
              <span class="state-value {% if product.state == 'In Stock' %}in-stock{% elif product.state == 'Low Stock' %}low-stock{% else %}out-stock{% endif %}">
                {{ product.state|default:"In Stock" }}
              </span>
            </div>
          </div>
          <div class="vertical-product-overlay">
            <h3 class="vertical-product-title">{{ product.name }}</h3>
            <p class="vertical-product-description">{{ product.description }}</p>
            <div class="status-container">
              <span class="trend {% if product.trend > 0 %}up{% elif product.trend < 0 %}down{% else %}neutral{% endif %}">
                {% if product.trend > 0 %}↑{% elif product.trend < 0 %}↓{% else %}→{% endif %} {{ product.trend }}%
              </span>
            </div>
            <button class="vertical-product-button">View Details</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- Product Popups -->
  {% for product in products %}
  <div class="product-popup-overlay" id="{{ product.id }}Popup">
    <div class="product-popup">
      <div class="product-popup-header">
        <img src="{% static product.image %}" alt="{{ product.name }}" class="product-popup-image">
        <div class="product-popup-close">&times;</div>
      </div>
      <div class="product-popup-content">
        <h2 class="product-popup-title">{{ product.name }}</h2>
        <div class="product-popup-details">
          <p class="product-popup-description">{{ product.description }}</p>
          <div class="product-popup-specs">
            {% for key, value in product.specifications.items %}
            <div class="product-popup-spec">
              <h4>{{ key|title }}</h4>
              <p>{{ value }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
        
        {% if product.details %}
        <div class="product-popup-details">
          <h3>Additional Details</h3>
          <ul>
            {% for detail in product.details %}
            <li>{{ detail }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if product.availability %}
        <div class="product-popup-details">
          <h3>Availability</h3>
          <div class="availability-chart">
            {% for month, status in product.availability.items %}
            <div class="month-status {% if status == 'high' %}high{% elif status == 'medium' %}medium{% elif status == 'low' %}low{% else %}none{% endif %}">
              <span class="month">{{ month }}</span>
              <div class="status-bar"></div>
              <span class="status-label">{{ status|title }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        <div class="product-popup-actions">
          <a href="{% url 'sample' %}?product={{ product.name }}" class="product-popup-button">
            <i class="fas fa-flask"></i> Request Sample
          </a>
          <a href="{% url 'quote' %}?product={{ product.name }}" class="product-popup-button">
            <i class="fas fa-file-invoice-dollar"></i> Get Quote
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Vertical Products Popup functionality
    const productCards = document.querySelectorAll('.vertical-product-card');
    const productPopups = document.querySelectorAll('.product-popup-overlay');
    const closeButtons = document.querySelectorAll('.product-popup-close');
    
    // Open popup when clicking on a product card
    productCards.forEach(card => {
      card.addEventListener('click', function() {
        const productId = this.getAttribute('data-product');
        const popup = document.getElementById(`${productId}Popup`);
        if (popup) {
          popup.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
      });
    });
    
    // Close popup when clicking on close button
    closeButtons.forEach(button => {
      button.addEventListener('click', function() {
        const popup = this.closest('.product-popup-overlay');
        popup.classList.remove('active');
        document.body.style.overflow = ''; // Re-enable scrolling
      });
    });
    
    // Close popup when clicking outside the popup content
    productPopups.forEach(popup => {
      popup.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
          document.body.style.overflow = ''; // Re-enable scrolling
        }
      });
    });
    
    // Close popup when pressing Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        productPopups.forEach(popup => {
          popup.classList.remove('active');
        });
        document.body.style.overflow = ''; // Re-enable scrolling
      }
    });

    // Filter functionality
    const filterButtons = document.querySelectorAll('.category-btn');
    
    // Debug: Log all product cards and their categories
    console.log('Product Cards:', productCards.length);
    productCards.forEach(card => {
      console.log('Product ID:', card.getAttribute('data-product'), 
                  'Category:', card.getAttribute('data-category'));
    });
    
    // Category mapping for display
    const categoryMapping = {
      'sesame': 'Oilseeds',
      'cotton': 'Fibers',
      'gum': 'Gums',
      'others': 'Other'
    };
    
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        const category = this.getAttribute('data-category');
        console.log('Selected category:', category);
        
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Filter products
        if (category === 'all') {
          productCards.forEach(card => {
            card.style.display = '';
          });
        } else {
          productCards.forEach(card => {
            const cardCategory = (card.getAttribute('data-category') || '').toLowerCase();
            if (cardCategory === category.toLowerCase()) {
              card.style.display = '';
            } else {
              card.style.display = 'none';
            }
          });
        }
        
        // If no products are visible after filtering, show a message
        let visibleCount = 0;
        productCards.forEach(card => {
          if (card.style.display !== 'none') {
            visibleCount++;
          }
        });
        
        const noProductsMessage = document.getElementById('no-products-message');
        if (visibleCount === 0) {
          if (!noProductsMessage) {
            const message = document.createElement('div');
            message.id = 'no-products-message';
            message.className = 'no-products-message';
            message.innerHTML = `<p>No products found in the "${categoryMapping[category] || category}" category.</p>`;
            document.querySelector('.vertical-products-container').appendChild(message);
          } else {
            noProductsMessage.style.display = '';
          }
        } else if (noProductsMessage) {
          noProductsMessage.style.display = 'none';
        }
      });
    });

    // Handle hash navigation
    const hash = window.location.hash.slice(1);
    if (hash) {
      const productElement = document.getElementById(hash);
      if (productElement) {
        productElement.scrollIntoView({ behavior: 'smooth' });
        setTimeout(() => {
          const productId = productElement.getAttribute('data-product');
          const popup = document.getElementById(`${productId}Popup`);
          if (popup) {
            popup.classList.add('active');
            document.body.style.overflow = 'hidden';
          }
        }, 500);
      }
    }
  });
</script>
{% endblock %}
