{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}CNF Products Management - Admin{% endblock %}

{% block styles %}
<style>
    :root {
        --accent: #786D3C;  /* Gold accent from logo */
        --primary-dark: #1B1464;  /* Dark blue from logo */
    }

    .cnf-products-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 30px;
    }

    .cnf-products-title {
        color: var(--primary-dark);
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 600;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 10px;
    }

    .cnf-products-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .cnf-products-table th {
        background-color: var(--primary-dark);
        color: white;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
    }

    .cnf-products-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    .cnf-products-table tr:hover {
        background-color: rgba(120, 109, 60, 0.1);
    }

    .cnf-products-table tr:last-child td {
        border-bottom: none;
    }

    .cnf-action-btn {
        background-color: var(--primary-dark);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        margin-right: 5px;
        display: inline-block;
        text-decoration: none;
    }

    .cnf-action-btn:hover {
        background-color: var(--accent);
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
    }

    .cnf-action-btn.edit {
        background-color: #4CAF50;
    }

    .cnf-action-btn.delete {
        background-color: #f44336;
    }

    .cnf-action-btn.link {
        background-color: #2196F3;
    }

    .cnf-action-btn.update {
        background-color: var(--accent);
    }

    .cnf-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .cnf-modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        width: 60%;
        max-width: 600px;
        position: relative;
    }

    .cnf-close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
    }

    .cnf-close-btn:hover {
        color: #333;
    }

    .cnf-form-group {
        margin-bottom: 20px;
    }

    .cnf-form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-dark);
    }

    .cnf-form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    .cnf-form-select {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        background-color: white;
    }

    .cnf-form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .cnf-form-col {
        flex: 1;
        min-width: 200px;
    }

    .cnf-submit-btn {
        background-color: var(--primary-dark);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin-top: 20px;
    }

    .cnf-submit-btn:hover {
        background-color: var(--accent);
        transform: translateY(-2px);
    }

    .cnf-alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }

    .cnf-alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .cnf-alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .cnf-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .cnf-badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .cnf-badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .cnf-badge-danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    .cnf-card {
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .cnf-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .cnf-card-header {
        border-bottom: 2px solid var(--accent);
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .cnf-card-title {
        color: var(--primary-dark);
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
    }

    .cnf-card-body {
        color: #333;
    }

    .cnf-card-footer {
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 15px;
        display: flex;
        justify-content: flex-end;
    }

    .cnf-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .cnf-tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        color: #555;
    }

    .cnf-tab.active {
        background-color: white;
        border-color: #ddd;
        color: var(--primary-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--accent);
    }

    .cnf-tab-content {
        display: none;
    }

    .cnf-tab-content.active {
        display: block;
    }

    .market-data-link {
        color: var(--accent);
        font-weight: 600;
        text-decoration: none;
    }

    .market-data-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }

    .linked-product-card {
        background-color: rgba(120, 109, 60, 0.05);
        border-left: 4px solid var(--accent);
    }

    .cnf-info-box {
        background-color: #e7f3fe;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
        .cnf-modal-content {
            width: 90%;
            margin: 20% auto;
        }

        .cnf-form-row {
            flex-direction: column;
            gap: 10px;
        }

        .cnf-action-btn {
            padding: 6px 10px;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
            text-align: center;
        }

        .cnf-products-table {
            display: block;
            overflow-x: auto;
        }

        .cnf-tabs {
            flex-wrap: wrap;
        }

        .cnf-tab {
            flex: 1;
            text-align: center;
            padding: 8px 10px;
            font-size: 0.9rem;
        }
    }

    /* Dashboard Summary Styles */
    .cnf-dashboard-summary {
        background-color: rgba(27, 20, 100, 0.05);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .cnf-summary-card {
        display: flex;
        align-items: center;
        padding: 20px;
        border: none;
        border-left: 4px solid var(--accent);
        border-radius: 5px;
        background-color: white;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .cnf-summary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .cnf-summary-icon {
        font-size: 2.2rem;
        margin-right: 15px;
        color: var(--primary-dark);
    }

    .cnf-summary-content {
        flex: 1;
    }

    .cnf-summary-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #555;
    }

    .cnf-summary-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-dark);
    }

    .cnf-exchange-rate-info {
        margin-top: 15px;
        padding: 10px 15px;
        background-color: rgba(120, 109, 60, 0.1);
        border-radius: 5px;
        font-size: 0.95rem;
        color: #333;
        display: inline-block;
    }
    
    .cnf-exchange-rate-info i {
        color: var(--accent);
        margin-right: 5px;
    }

    /* New styles for linked product card */
    .cnf-card-header.d-flex {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .cnf-product-info {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .cnf-info-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .cnf-info-item i {
        font-size: 1.2rem;
        color: var(--primary-dark);
    }

    .cnf-market-data-link {
        margin-bottom: 20px;
    }

    .cnf-linked-market-data {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: #f9f9f9;
    }

    .cnf-market-values {
        margin-bottom: 20px;
    }

    .cnf-section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--primary-dark);
    }

    .cnf-market-values-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }

    .cnf-market-value-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border: 1px solid rgba(120, 109, 60, 0.2);
        border-radius: 5px;
        background-color: #f9f9f9;
        transition: all 0.2s ease;
    }

    .cnf-market-value-item:hover {
        background-color: rgba(120, 109, 60, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .cnf-market-location {
        font-weight: 600;
        color: var(--primary-dark);
    }

    .cnf-market-price {
        font-weight: 700;
        color: var(--accent);
    }

    .cnf-last-updated {
        font-size: 0.9rem;
        color: #666;
        margin-top: 15px;
        padding: 8px 12px;
        background-color: rgba(27, 20, 100, 0.05);
        border-radius: 4px;
        display: inline-block;
    }
    
    /* Market Data Card Styles */
    .market-data-card {
        border-left: 4px solid var(--accent);
        background-color: white;
        transition: all 0.3s ease;
    }
    
    .market-data-card:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        transform: translateY(-5px);
    }
    
    .market-data-card .cnf-card-header {
        background-color: rgba(27, 20, 100, 0.03);
        padding: 15px;
        border-bottom: 2px solid var(--accent);
    }
    
    .market-data-card .cnf-section-title {
        border-bottom: 1px dashed rgba(120, 109, 60, 0.3);
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="cnf-products-container">
        <h2 class="cnf-products-title">CNF Products Management</h2>
        
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="cnf-alert {% if message.tags == 'success' %}cnf-alert-success{% elif message.tags == 'error' %}cnf-alert-danger{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Dashboard Summary Section -->
        <div class="cnf-dashboard-summary mb-4">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="cnf-summary-card">
                        <div class="cnf-summary-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="cnf-summary-content">
                            <h4 class="cnf-summary-title">Total Products</h4>
                            <p class="cnf-summary-value">{{ products|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="cnf-summary-card">
                        <div class="cnf-summary-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <div class="cnf-summary-content">
                            <h4 class="cnf-summary-title">Linked Products</h4>
                            <p class="cnf-summary-value">{{ linked_products|length }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="cnf-summary-card">
                        <div class="cnf-summary-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="cnf-summary-content">
                            <h4 class="cnf-summary-title">Available Market Data</h4>
                            <p class="cnf-summary-value">{{ available_market_data|length }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% if exchange_rate %}
            <div class="cnf-exchange-rate-info">
                <i class="fas fa-money-bill-wave"></i> Current Exchange Rate: <strong>{{ exchange_rate.usd_to_sdg }} SDG/USD</strong> (as of {{ exchange_rate.date|date:"M d, Y" }})
            </div>
            {% endif %}
        </div>

        <div class="cnf-tabs">
            <div class="cnf-tab active" data-tab="products">Products</div>
            <div class="cnf-tab" data-tab="linked">Linked Products</div>
            <div class="cnf-tab" data-tab="market-data">Available Market Data</div>
        </div>

        <!-- Products Tab -->
        <div class="cnf-tab-content active" id="products-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>All CNF Products</h3>
                <button class="cnf-action-btn" id="addProductBtn">Add New Product</button>
            </div>

            {% if products %}
            <div class="table-responsive">
                <table class="cnf-products-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Cost (SDG)</th>
                            <th>Waste %</th>
                            <th>Market Data</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>{{ product.name }}</td>
                            <td>{{ product.cost_per_unit_sdg }}</td>
                            <td>{{ product.waste_percentage }}%</td>
                            <td>
                                {% if product.market_data %}
                                <span class="cnf-badge cnf-badge-success">
                                    <i class="fas fa-link"></i> {{ product.market_data.name }}
                                </span>
                                {% else %}
                                <span class="cnf-badge cnf-badge-warning">Not Linked</span>
                                {% endif %}
                            </td>
                            <td>{{ product.updated_at|date:"M d, Y" }}</td>
                            <td>
                                <button class="cnf-action-btn edit edit-product-btn" data-id="{{ product.id }}" data-name="{{ product.name }}" data-cost="{{ product.cost_per_unit_sdg }}" data-waste="{{ product.waste_percentage }}" data-market-data="{% if product.market_data %}{{ product.market_data.id }}{% endif %}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="cnf-action-btn delete delete-product-btn" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                                {% if not product.market_data %}
                                <button class="cnf-action-btn link link-product-btn" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                    <i class="fas fa-link"></i> Link
                                </button>
                                {% else %}
                                <button class="cnf-action-btn update update-prices-btn" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                    <i class="fas fa-sync-alt"></i> Update Prices
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="cnf-info-box">
                <p>No CNF products found. Click "Add New Product" to create your first product.</p>
            </div>
            {% endif %}
        </div>

        <!-- Linked Products Tab -->
        <div class="cnf-tab-content" id="linked-tab">
            <h3>Products Linked to Market Data</h3>
            
            {% if linked_products %}
            <div class="row">
                {% for product in linked_products %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="cnf-card linked-product-card">
                        <div class="cnf-card-header d-flex justify-content-between align-items-center">
                            <h4 class="cnf-card-title">{{ product.name }}</h4>
                            <span class="cnf-badge cnf-badge-success">
                                <i class="fas fa-link"></i> Linked
                            </span>
                        </div>
                        <div class="cnf-card-body">
                            <div class="cnf-product-info mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="cnf-info-item">
                                            <i class="fas fa-dollar-sign text-primary"></i>
                                            <div>
                                                <small>Base Cost</small>
                                                <p class="mb-0 font-weight-bold">{{ product.cost_per_unit_sdg }} SDG</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="cnf-info-item">
                                            <i class="fas fa-percentage text-warning"></i>
                                            <div>
                                                <small>Waste</small>
                                                <p class="mb-0 font-weight-bold">{{ product.waste_percentage }}%</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="cnf-market-data-link mb-3">
                                <h5 class="cnf-section-title">
                                    <i class="fas fa-chart-line" style="color: var(--accent);"></i> Market Data
                                </h5>
                                <div class="cnf-linked-market-data">
                                    <a href="/admin/core/marketdata/{{ product.market_data.id }}/change/" class="market-data-link" target="_blank">
                                        {{ product.market_data.name }} <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            </div>
                            
                            {% if exchange_rate %}
                            <div class="cnf-market-values">
                                <h5 class="cnf-section-title">
                                    <i class="fas fa-globe" style="color: var(--primary-dark);"></i> Market Values
                                </h5>
                                <div class="cnf-market-values-grid">
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">Port Sudan</span>
                                        <span class="cnf-market-price">{{ product.market_data.port_sudan }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">China</span>
                                        <span class="cnf-market-price">{{ product.market_data.dmt_china }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">UAE</span>
                                        <span class="cnf-market-price">{{ product.market_data.dmt_uae }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">Mersing</span>
                                        <span class="cnf-market-price">{{ product.market_data.dmt_mersing }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">India</span>
                                        <span class="cnf-market-price">{{ product.market_data.dmt_india }}</span>
                                    </div>
                                </div>
                                <p class="cnf-last-updated">
                                    <i class="fas fa-clock"></i> Updated: {{ product.market_data.last_update|date:"M d, Y H:i" }}
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        <div class="cnf-card-footer">
                            <button class="cnf-action-btn edit edit-product-btn" data-id="{{ product.id }}" data-name="{{ product.name }}" data-cost="{{ product.cost_per_unit_sdg }}" data-waste="{{ product.waste_percentage }}" data-market-data="{{ product.market_data.id }}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="cnf-action-btn update update-prices-btn" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                <i class="fas fa-sync-alt"></i> Update Prices
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="cnf-info-box">
                <p>No products are currently linked to market data. Use the "Link" button in the Products tab to link a product to market data.</p>
            </div>
            {% endif %}
        </div>

        <!-- Available Market Data Tab -->
        <div class="cnf-tab-content" id="market-data-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Available Market Data</h3>
                <a href="/admin/core/marketdata/add/" class="cnf-action-btn" target="_blank">
                    <i class="fas fa-plus"></i> Add New Market Data
                </a>
            </div>
            
            {% if available_market_data %}
            <div class="row">
                {% for market_data in available_market_data %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="cnf-card market-data-card">
                        <div class="cnf-card-header d-flex justify-content-between align-items-center">
                            <h4 class="cnf-card-title">{{ market_data.name }}</h4>
                            <span class="cnf-badge cnf-badge-warning">
                                <i class="fas fa-unlink"></i> Unlinked
                            </span>
                        </div>
                        <div class="cnf-card-body">
                            <div class="cnf-market-data-info">
                                <h5 class="cnf-section-title">
                                    <i class="fas fa-globe" style="color: var(--primary-dark);"></i> Market Values
                                </h5>
                                <div class="cnf-market-values-grid">
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">Port Sudan</span>
                                        <span class="cnf-market-price">{{ market_data.port_sudan }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">China</span>
                                        <span class="cnf-market-price">{{ market_data.dmt_china }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">UAE</span>
                                        <span class="cnf-market-price">{{ market_data.dmt_uae }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">Mersing</span>
                                        <span class="cnf-market-price">{{ market_data.dmt_mersing }}</span>
                                    </div>
                                    <div class="cnf-market-value-item">
                                        <span class="cnf-market-location">India</span>
                                        <span class="cnf-market-price">{{ market_data.dmt_india }}</span>
                                    </div>
                                </div>
                                <p class="cnf-last-updated">
                                    <i class="fas fa-clock"></i> Updated: {{ market_data.last_update|date:"M d, Y H:i" }}
                                </p>
                            </div>
                        </div>
                        <div class="cnf-card-footer">
                            <a href="/admin/core/marketdata/{{ market_data.id }}/change/" class="cnf-action-btn" target="_blank">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button class="cnf-action-btn link link-to-product-btn" data-market-data-id="{{ market_data.id }}" data-market-data-name="{{ market_data.name }}">
                                <i class="fas fa-link"></i> Link to Product
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="cnf-info-box">
                <p>No available market data found. All market data items are already linked to products.</p>
                <p>You can create new market data items in the <a href="/admin/core/marketdata/add/" class="market-data-link" target="_blank">Market Data admin</a>.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Product Modal -->
<div id="productModal" class="cnf-modal">
    <div class="cnf-modal-content">
        <span class="cnf-close-btn">&times;</span>
        <h3 id="productModalTitle">Add New Product</h3>
        <form id="productForm" method="post" action="{% url 'admin_cnf_products_save' %}">
            {% csrf_token %}
            <input type="hidden" id="product_id" name="product_id">
            
            <div class="cnf-form-group">
                <label for="name">Product Name</label>
                <input type="text" class="cnf-form-control" id="name" name="name" required>
            </div>
            
            <div class="cnf-form-row">
                <div class="cnf-form-col">
                    <div class="cnf-form-group">
                        <label for="cost_per_unit_sdg">Cost per Unit (SDG)</label>
                        <input type="number" step="0.01" class="cnf-form-control" id="cost_per_unit_sdg" name="cost_per_unit_sdg" required>
                    </div>
                </div>
                <div class="cnf-form-col">
                    <div class="cnf-form-group">
                        <label for="waste_percentage">Waste Percentage (%)</label>
                        <input type="number" step="0.01" class="cnf-form-control" id="waste_percentage" name="waste_percentage" required>
                    </div>
                </div>
            </div>
            
            <div class="cnf-form-group">
                <label for="market_data">Link to Market Data (Optional)</label>
                <select class="cnf-form-select" id="market_data" name="market_data">
                    <option value="">-- Select Market Data --</option>
                    {% for market_data in available_market_data %}
                    <option value="{{ market_data.id }}">{{ market_data.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-muted">Linking a product to market data will automatically update the market data prices based on CNF calculations.</small>
            </div>
            
            <button type="submit" class="cnf-submit-btn">Save Product</button>
        </form>
    </div>
</div>

<!-- Link Modal -->
<div id="linkModal" class="cnf-modal">
    <div class="cnf-modal-content">
        <span class="cnf-close-btn">&times;</span>
        <h3 id="linkModalTitle">Link Product to Market Data</h3>
        <form id="linkForm" method="post" action="{% url 'admin_cnf_products_link' %}">
            {% csrf_token %}
            <input type="hidden" id="link_product_id" name="product_id">
            
            <div class="cnf-form-group">
                <label for="market_data">Select Market Data</label>
                <select class="cnf-form-select" id="market_data" name="market_data" required>
                    <option value="">-- Select Market Data --</option>
                    {% for market_data in available_market_data %}
                    <option value="{{ market_data.id }}">{{ market_data.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="cnf-submit-btn">Link Product</button>
        </form>
    </div>
</div>

<!-- Link to Product Modal -->
<div id="linkToProductModal" class="cnf-modal">
    <div class="cnf-modal-content">
        <span class="cnf-close-btn">&times;</span>
        <h3 id="linkToProductModalTitle">Link Market Data to Product</h3>
        <form id="linkToProductForm" method="post" action="{% url 'admin_cnf_products_link' %}">
            {% csrf_token %}
            <input type="hidden" id="link_market_data_id" name="market_data">
            
            <div class="cnf-form-group">
                <label for="product_id">Select Product</label>
                <select class="cnf-form-select" id="product_id" name="product_id" required>
                    <option value="">-- Select Product --</option>
                    {% for product in products %}
                    {% if not product.market_data %}
                    <option value="{{ product.id }}">{{ product.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="cnf-submit-btn">Link to Product</button>
        </form>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal" class="cnf-modal">
    <div class="cnf-modal-content">
        <span class="cnf-close-btn">&times;</span>
        <h3>Delete Product</h3>
        <p>Are you sure you want to delete the product "<span id="delete_product_name"></span>"?</p>
        <p class="text-danger">This action cannot be undone.</p>
        
        <form id="deleteForm" method="post" action="{% url 'admin_cnf_products_delete' %}">
            {% csrf_token %}
            <input type="hidden" id="delete_product_id" name="product_id">
            
            <div class="d-flex justify-content-end mt-4">
                <button type="button" class="cnf-action-btn mr-2 cancel-delete-btn">Cancel</button>
                <button type="submit" class="cnf-action-btn delete">Delete</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get modal elements
        const productModal = document.getElementById('productModal');
        const linkModal = document.getElementById('linkModal');
        const linkToProductModal = document.getElementById('linkToProductModal');
        const deleteModal = document.getElementById('deleteModal');
        const closeBtns = document.querySelectorAll('.cnf-close-btn');
        
        // Get form elements
        const productForm = document.getElementById('productForm');
        const linkForm = document.getElementById('linkForm');
        const linkToProductForm = document.getElementById('linkToProductForm');
        const deleteForm = document.getElementById('deleteForm');
        
        // Get button elements
        const addProductBtn = document.getElementById('addProductBtn');
        const editProductBtns = document.querySelectorAll('.edit-product-btn');
        const deleteProductBtns = document.querySelectorAll('.delete-product-btn');
        const linkProductBtns = document.querySelectorAll('.link-product-btn');
        const linkToProductBtns = document.querySelectorAll('.link-to-product-btn');
        const updatePricesBtns = document.querySelectorAll('.update-prices-btn');
        const cancelDeleteBtn = document.querySelector('.cancel-delete-btn');
        
        // Tab navigation
        const tabs = document.querySelectorAll('.cnf-tab');
        const tabContents = document.querySelectorAll('.cnf-tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Add Product button click
        addProductBtn.addEventListener('click', function() {
            // Reset form
            productForm.reset();
            document.getElementById('product_id').value = '';
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            
            // Show modal
            productModal.style.display = 'block';
        });
        
        // Edit Product button click
        editProductBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const cost = this.getAttribute('data-cost');
                const waste = this.getAttribute('data-waste');
                const marketDataId = this.getAttribute('data-market-data');
                
                // Set form values
                document.getElementById('product_id').value = id;
                document.getElementById('name').value = name;
                document.getElementById('cost_per_unit_sdg').value = cost;
                document.getElementById('waste_percentage').value = waste;
                document.getElementById('market_data').value = marketDataId || '';
                
                // Set modal title
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                
                // Show modal
                productModal.style.display = 'block';
            });
        });
        
        // Delete Product button click
        deleteProductBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                
                // Set form values
                document.getElementById('delete_product_id').value = id;
                document.getElementById('delete_product_name').textContent = name;
                
                // Show modal
                deleteModal.style.display = 'block';
            });
        });
        
        // Cancel delete button click
        cancelDeleteBtn.addEventListener('click', function() {
            deleteModal.style.display = 'none';
        });
        
        // Link Product button click
        linkProductBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                
                // Set form values
                document.getElementById('link_product_id').value = id;
                document.getElementById('product_name').value = name;
                
                // Show modal
                linkModal.style.display = 'block';
            });
        });
        
        // Link to Product button click
        linkToProductBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const marketDataId = this.getAttribute('data-market-data-id');
                const marketDataName = this.getAttribute('data-market-data-name');
                
                // Set form values
                document.getElementById('link_market_data_id').value = marketDataId;
                
                // Set modal title
                document.getElementById('linkToProductModalTitle').textContent = `Link ${marketDataName} to Product`;
                
                // Show modal
                linkToProductModal.style.display = 'block';
            });
        });
        
        // Update Prices button click
        updatePricesBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                
                if (confirm(`Update market data prices for "${name}"?`)) {
                    // Send AJAX request to update prices
                    fetch('/api/cnf/update-market-data-prices/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            product_id: id
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating prices.');
                    });
                }
            });
        });
        
        // Close modal when clicking close button
        closeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                productModal.style.display = 'none';
                linkModal.style.display = 'none';
                linkToProductModal.style.display = 'none';
                deleteModal.style.display = 'none';
            });
        });
        
        // Close modal when clicking outside modal
        window.addEventListener('click', function(event) {
            if (event.target == productModal) {
                productModal.style.display = 'none';
            }
            if (event.target == linkModal) {
                linkModal.style.display = 'none';
            }
            if (event.target == linkToProductModal) {
                linkToProductModal.style.display = 'none';
            }
            if (event.target == deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
