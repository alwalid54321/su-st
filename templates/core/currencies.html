{% extends 'base.html' %}
{% load static %}

{% block title %}Currency Exchange - SudaStock{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/currencies.css' %}">
<style>
    .currency-flag img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>
{% endblock %}

{% block content %}
<div class="currencies-page">
    <div class="hero-section">
        <div class="hero-content">
            <h1>Currency Exchange Rates</h1>
            <p>Current exchange rates and trends for major currencies</p>
        </div>
    </div>

    <div class="container">
        <div class="currency-filters">
            <div class="filter-group">
                <label for="baseCurrency">Base Currency:</label>
                <select id="baseCurrency" class="form-select">
                    <option value="USD">US Dollar (USD)</option>
                    <option value="SDG">Sudanese Pound (SDG)</option>
                    <option value="AED">UAE Dirham (AED)</option>
                </select>
            </div>
        </div>

        <div class="currency-cards">
            {% for currency in currencies %}
            <div class="currency-card">
                <div class="currency-flag">
                    <img src="{% static 'images/flags/'|add:currency.code|lower|slice:':3'|add:'.png' %}" alt="{{ currency.code }} Flag">
                </div>
                <div class="currency-info">
                    <h3>{{ currency.name }}</h3>
                    <p class="currency-code">{{ currency.code }}</p>
                    <div class="exchange-rate" data-usd="{{ currency.rate_to_usd }}">
                        <span class="rate-value">{{ currency.rate_to_usd|floatformat:4 }}</span>
                        <span class="rate-label">USD / {{ currency.code }}</span>
                    </div>
                    <div class="trend {% if currency.trend > 0 %}up{% elif currency.trend < 0 %}down{% else %}neutral{% endif %}">
                        {% if currency.trend > 0 %}
                        <span class="trend-arrow">↑</span>
                        {% elif currency.trend < 0 %}
                        <span class="trend-arrow">↓</span>
                        {% else %}
                        <span class="trend-arrow">→</span>
                        {% endif %}
                        <span class="trend-value">{{ currency.trend }}%</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-data">
                <p>No currency data available</p>
            </div>
            {% endfor %}
        </div>

        <div class="currency-table-section">
            <h2>Exchange Rate Table</h2>
            <div class="currency-table">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Currency</th>
                            <th>Code</th>
                            <th>Rate (USD)</th>
                            <th>Trend</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for currency in currencies %}
                        <tr>
                            <td>
                                <div class="currency-name">
                                    <img src="{% static 'images/flags/'|add:currency.code|lower|slice:':3'|add:'.png' %}" alt="{{ currency.code }} Flag" class="mini-flag">
                                    {{ currency.name }}
                                </div>
                            </td>
                            <td>{{ currency.code }}</td>
                            <td class="rate-cell" data-usd="{{ currency.rate_to_usd }}">{{ currency.rate_to_usd|floatformat:4 }}</td>
                            <td>
                                <span class="trend-indicator {% if currency.trend > 0 %}up{% elif currency.trend < 0 %}down{% else %}neutral{% endif %}">
                                    {% if currency.trend > 0 %}↑{% elif currency.trend < 0 %}↓{% else %}→{% endif %} {{ currency.trend }}%
                                </span>
                            </td>
                            <td>{{ currency.updated_at|date:"M d, Y H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="currency-converter">
            <h2>Currency Converter</h2>
            <div class="converter-container">
                <div class="converter-form">
                    <div class="form-group">
                        <label for="fromAmount">Amount</label>
                        <input type="number" id="fromAmount" class="form-control" value="1">
                    </div>
                    <div class="form-group">
                        <label for="fromCurrency">From</label>
                        <select id="fromCurrency" class="form-select">
                            <option value="USD">US Dollar (USD)</option>
                            <option value="SDG">Sudanese Pound (SDG)</option>
                            <option value="AED">UAE Dirham (AED)</option>
                            {% for currency in currencies %}
                            {% if currency.code != "USD" and currency.code != "SDG" and currency.code != "AED" %}
                            <option value="{{ currency.code }}">{{ currency.name }} ({{ currency.code }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="swap-button">
                        <button id="swapCurrencies" class="btn btn-outline-primary">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="toCurrency">To</label>
                        <select id="toCurrency" class="form-select">
                            <option value="SDG">Sudanese Pound (SDG)</option>
                            <option value="USD">US Dollar (USD)</option>
                            <option value="AED">UAE Dirham (AED)</option>
                            {% for currency in currencies %}
                            {% if currency.code != "USD" and currency.code != "SDG" and currency.code != "AED" %}
                            <option value="{{ currency.code }}">{{ currency.name }} ({{ currency.code }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="conversion-result">
                    <div class="result-amount">
                        <span id="resultValue">950.00</span>
                    </div>
                    <div class="conversion-details">
                        <p>1 USD = <span id="conversionRate">950.00 SDG</span></p>
                        <p class="update-time">Last updated: <span id="lastUpdated">{{ currencies.0.updated_at|date:"M d, Y H:i" }}</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="currency-disclaimer">
            <p><strong>Disclaimer:</strong> The exchange rates provided are for informational purposes only and may not reflect real-time market conditions. Rates are updated daily and represent the average market rate. For the most accurate and up-to-date information, please contact our team.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Currency conversion data
        const currencies = {
            {% for currency in currencies %}
            "{{ currency.code }}": {
                rate: {{ currency.rate }},
                name: "{{ currency.name }}"
            },
            {% endfor %}
            "USD": { rate: 1, name: "US Dollar" },
            "SDG": { rate: 950, name: "Sudanese Pound" },
            "AED": { rate: 3.67, name: "UAE Dirham" }
        };
        
        // Currency converter functionality
        const fromAmount = document.getElementById('fromAmount');
        const fromCurrency = document.getElementById('fromCurrency');
        const toCurrency = document.getElementById('toCurrency');
        const swapButton = document.getElementById('swapCurrencies');
        const resultValue = document.getElementById('resultValue');
        const conversionRate = document.getElementById('conversionRate');
        
        function updateConversion() {
            const amount = parseFloat(fromAmount.value);
            const from = fromCurrency.value;
            const to = toCurrency.value;
            
            if (isNaN(amount)) return;
            
            // Convert to USD first, then to target currency
            const amountInUSD = amount / currencies[from].rate;
            const convertedAmount = amountInUSD * currencies[to].rate;
            
            resultValue.textContent = convertedAmount.toFixed(2);
            conversionRate.textContent = `${(currencies[to].rate / currencies[from].rate).toFixed(4)} ${to}`;
        }
        
        // Event listeners
        fromAmount.addEventListener('input', updateConversion);
        fromCurrency.addEventListener('change', updateConversion);
        toCurrency.addEventListener('change', updateConversion);
        
        swapButton.addEventListener('click', function() {
            const temp = fromCurrency.value;
            fromCurrency.value = toCurrency.value;
            toCurrency.value = temp;
            updateConversion();
        });
        
        // Base currency change functionality
        const baseCurrency = document.getElementById('baseCurrency');
        
        baseCurrency.addEventListener('change', function() {
            const base = this.value;
            
            // Update currency cards
            document.querySelectorAll('.exchange-rate').forEach(el => {
                const usdRate = parseFloat(el.getAttribute('data-usd'));
                const baseRate = currencies[base].rate;
                const newRate = usdRate / baseRate;
                
                el.querySelector('.rate-value').textContent = newRate.toFixed(4);
                el.querySelector('.rate-label').textContent = `${base} / ${el.closest('.currency-card').querySelector('.currency-code').textContent}`;
            });
            
            // Update table rates
            document.querySelectorAll('.rate-cell').forEach(el => {
                const usdRate = parseFloat(el.getAttribute('data-usd'));
                const baseRate = currencies[base].rate;
                const newRate = usdRate / baseRate;
                
                el.textContent = newRate.toFixed(4);
            });
        });
        
        // Initialize conversion
        updateConversion();
    });
</script>
{% endblock %}
